<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyleaMUN Student Officer Vote & Tally</title>
    <style>
        /* Base styles from index.html */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #E8EAE6; color: #333; }
        .hidden { display: none !important; }
        .letterhead { display: flex; justify-content: space-between; align-items: center; background-color: #D6DBD2; border-bottom: 2px solid #444; padding: 10px 20px; min-height: 100px; flex-wrap: wrap; }
        .address, .contact { width: 30%; font-size: 0.9rem; }
        .contact { display: flex; flex-direction: column; align-items: flex-end; }
        .logo-container { width: 120px; text-align: center; }
        .logo { width: 120px; height: auto; }
        .letterhead a { color: #0066cc; text-decoration: none; }
        main { padding: 2em; max-width: 1000px; margin: auto; }
        h1, h2 { text-align: center; color: #005b63; }
        .container { background: #e0f7fa; padding: 2em; border-radius: 16px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        /* Button and Status styles */
        .button-group { display: flex; justify-content: center; gap: 10px; margin: 1.5em 0; flex-wrap: wrap; }
        .btn { background-color: #00b4a0; color: white; font-size: 1em; padding: 0.8em 1.5em; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { background-color: #00897b; }
        .btn.primary { background-color: #00b4a0; }
        .btn.danger { background-color: #d32f2f; }
        
        /* Specific element styles */
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; background-color: white; font-size: 1em; width: 90%; box-sizing: border-box; }
        .voter-auth { display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px; }
        .alert-box { background-color: #ffeb3b; color: #333; padding: 10px 20px; border-radius: 8px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        #status { text-align: center; font-weight: bold; color: #004d40; margin-top: 1em; min-height: 24px; font-size: 1.1em; }
        
        /* Voting Form Layout */
        #candidate-list { list-style: none; padding: 0; }
        #candidate-list li { 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Name, Committee, Post */
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #cceeff;
        }
        .grid-header { display: grid; grid-template-columns: 1fr 1fr 1fr; font-weight: bold; padding: 10px 0; margin-bottom: 10px; border-bottom: 2px solid #005b63; }
        .grid-header div { text-align: center; }
        .grid-header div:first-child { text-align: left; padding-left: 0; }

        /* Tally Specific Styles */
        .tally-summary { margin-top: 20px; text-align: left; }
        .tally-committee { margin-bottom: 30px; padding: 15px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tally-committee h3 { margin-top: 0; color: #00796b; border-bottom: 1px solid #b2dfdb; padding-bottom: 5px; }
        .tally-results { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tally-item { padding: 5px 0; border-bottom: 1px dotted #ccc; display: flex; justify-content: space-between; }
        .tally-item:last-child { border-bottom: none; }
        .candidate-name { font-weight: 600; color: #333; }
        .vote-count { font-weight: 700; color: #00b4a0; font-size: 1.1em; }
        
    </style>
</head>
<body>
    <!-- Header shared across all views -->
    <div class="letterhead">
        <div class="address"><strong>4 Isminis Str.</strong><br>Pylaia, Thessaloniki - 55535</div>
        <div class="logo-container"><img src="https://pyleamun.github.io/interview-guide/pyleaMUNfinallogo_transparent.png" alt="PyleaMUN Logo" class="logo"></div>
        <div class="contact">
            <div>üìû +30 2310329199</div>
            <div>üìß <a href="mailto:pyleamun@gmail.com">pyleamun@gmail.com</a></div>
            <div>üåê <a href="https://pyleamun.github.io/pyleamun2026/" target="_blank">pyleamun.github.io/pyleamun2026</a></div>
        </div>
    </div>

    <main>
        <!-- 0. Initial Password Screen (Hidden by default, shown by query param) -->
        <div id="password-screen" class="hidden">
            <h1 style="color: #d32f2f;">üîê Admin Access Required</h1>
            <div class="container voter-auth">
                <h2>PyleaMUN Tally</h2>
                <input type="password" id="admin-password" placeholder="Enter Admin Password" style="padding: 10px; width: 250px; border-radius: 8px; border: 1px solid #ccc;">
                <button id="password-btn" class="btn secondary">View Results</button>
                <div id="password-status" style="color: #d32f2f; margin-top: 10px;"></div>
            </div>
        </div>

        <!-- 1. Voter Authentication Screen -->
        <div id="auth-screen" class="hidden">
            <h1>üó≥Ô∏è Student Officer Voting</h1>
            <div class="container voter-auth">
                <h2>Voter Identification</h2>
                <div class="alert-box">‚ö†Ô∏è **IMPORTANT:** You can vote only once. Choose your name carefully!</div>
                <label for="voter-select" style="font-size: 1.1em; font-weight: 600;">Select Your Name:</label>
                <select id="voter-select">
                    <option value="" disabled selected>-- Select your name --</option>
                </select>
                <button id="enter-btn" class="btn primary" disabled>Enter Voting Booth</button>
                <div id="auth-status" style="color: #d32f2f;"></div>
            </div>
        </div>

        <!-- 2. Main Voting Screen -->
        <div id="voting-screen" class="hidden">
            <h1>üó≥Ô∏è PyleaMUN Student Officer Vote</h1>
            <div class="container">
                <p id="voter-greeting" style="text-align: center; font-size: 1.2em; color: #00796b;"></p>
                <div class="alert-box">‚ö†Ô∏è **Final Reminder:** You can vote only once. Your vote is recorded once you click 'Submit Vote'.</div>

                <form id="voting-form">
                    <div class="grid-header">
                        <div>Candidate Name</div>
                        <div>Proposed Committee</div>
                        <div>Proposed Post</div>
                    </div>
                    <ul id="candidate-list">
                        <!-- Candidate rows will be populated by JavaScript -->
                    </ul>
                    <div class="button-group">
                        <button type="submit" class="btn primary">Submit Vote</button>
                    </div>
                </form>
                <div id="status"></div>
            </div>
        </div>

        <!-- 3. Admin Tally Screen -->
        <div id="admin-screen" class="hidden">
            <h1>üìä Student Officer Vote Tally</h1>
            <div class="container">
                <p id="tally-status" style="text-align: center; font-size: 1.2em; color: #00796b;"></p>
                <div id="tally-summary">
                    <!-- Results will be displayed here -->
                </div>
                <div class="button-group">
                    <button class="btn primary" onclick="renderTally()">Refresh Results</button>
                    <!-- New Clear Data Button -->
                    <button class="btn danger" id="clear-data-btn">Clear All Votes (Admin)</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Modular Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // ====================================================================
        // --- 1. CONFIGURATION BLOCK ---
        // ====================================================================
        
        const ADMIN_PASSWORD = "vote1026"; 
        const SUPER_ADMIN_PASSWORD = "president-panos"; 
        
        // Your web app's Firebase configuration (NOW WITH EXPLICIT databaseURL)
        const firebaseConfig = {
            apiKey: "AIzaSyBo2GRHsqz6LwvISHMiNa-eMaThNb1xwCs",
            authDomain: "pyleamun-vote.firebaseapp.com",
            projectId: "pyleamun-vote",
            storageBucket: "pyleamun-vote.firebasestorage.app",
            messagingSenderId: "251868969983",
            appId: "1:251868969983:web:931ba1d87843eab7ccc5ca",
            // CORRECTED: Using the specific, regional Realtime Database URL
            databaseURL: "https://pyleamun-vote-default-rtdb.europe-west1.firebasedatabase.app" 
        };
        
        // Database Constants
        const VOTES_NODE = 'officer_votes';
        const VOTER_SESSION_KEY = 'pyleamun-voter-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // --- DATA ARRAYS (Must be Finalized) ---
        const CANDIDATES = [
            "Aidoni Rafaela", "Angelaki-Mertzemeki Sofia", "Anyparidou Despoina", 
            "Asimakopoulou Ariadni", "Belliou Ioanna", "Bletsas Evangelos", 
            "Della Puppa Anna Maria", "Kaimakamis Kostantinos", "Kalomoiropoulou Evelyn", 
            "Karali Paraskevi", "Konstantou Panagiota", "Markadas Ioannis", 
            "Marmorkos Kostantinos", "Mastrokosta Danai", "Mavromati Maria Eleonora", 
            "Pachini Aikaterini", "Polymeri Kira", "Polymeri Stella", 
            "Ramadanis Asterios", "Stoltidis Miltiadis", "Stoltidou Nikoleta", 
            "Triantafyllou Angelos", "Tsitroudi Niki", "Zarogianni Ioanna"
        ];
        
        const VOTERS = [
            "Domvros", "Eskiktzis", "Goudas", "Kokkonos", "Liakou", 
            "Loukas", "Moutropoulou", "Paidaraki", "Papadopoulos", 
            "Papakrivos", "Pavlidis", "Saralekou", "Sougari", "Vasilikou"
        ];

        const COMMITTEES = [
            "UN Environment Programme (UNEP)", "Security Council", 
            "Economic and Social Council (ECOSOC)", "UNESCO", "NATO", 
            "World Health Organisation (WHO)", "Human Rights Council (HRC)", 
            "UN Women"
        ];

        const POSTS = ["Chair", "Co-Chair"];
        

        // ====================================================================
        // --- 2. AUTHENTICATION & VIEW MANAGEMENT ---
        // ====================================================================

        function showScreen(screenId) {
            document.querySelectorAll('#auth-screen, #voting-screen, #admin-screen, #password-screen').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function checkInitialView() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') !== null) {
                showScreen('password-screen');
                return;
            }

            const storedVoter = sessionStorage.getItem(VOTER_SESSION_KEY);
            if (storedVoter) {
                document.getElementById('voter-select').value = storedVoter;
                handleEnter(); 
            } else {
                showScreen('auth-screen');
            }
        }
        
        // --- Admin Password Logic ---
        document.getElementById('password-btn').addEventListener('click', () => {
            const enteredPassword = document.getElementById('admin-password').value;
            const statusEl = document.getElementById('password-status');

            if (enteredPassword === ADMIN_PASSWORD) {
                renderTally(); 
                showScreen('admin-screen');
            } else {
                statusEl.textContent = "‚ùå Incorrect Password.";
            }
        });
        
        // --- Voter Entry Logic ---
        function populateVoterSelect() {
            const selectEl = document.getElementById('voter-select');
            VOTERS.forEach(voter => {
                const option = document.createElement('option');
                option.value = voter;
                option.textContent = voter;
                selectEl.appendChild(option);
            });

            selectEl.addEventListener('change', () => {
                document.getElementById('enter-btn').disabled = !selectEl.value;
            });
        }
        
        async function handleEnter() {
            const voterName = document.getElementById('voter-select').value;
            const authStatusEl = document.getElementById('auth-status');

            if (!voterName) { return; }
            
            authStatusEl.textContent = "Checking vote status...";

            try {
                const voterRef = ref(database, `${VOTES_NODE}/${voterName}`);
                const snapshot = await get(voterRef);
                
                if (snapshot.exists()) {
                    authStatusEl.textContent = `‚ùå Error: The user "${voterName}" has already cast a vote on ${new Date(snapshot.val().timestamp).toLocaleString()}.`;
                    return;
                }

                sessionStorage.setItem(VOTER_SESSION_KEY, voterName);
                showScreen('voting-screen');
                document.getElementById('voter-greeting').textContent = `Welcome, ${voterName}. Please cast your votes for the Student Officers below.`;
                populateCandidateList();
            } catch (error) {
                authStatusEl.textContent = `‚ùå Error connecting to the database. Please try again.`;
                console.error("Firebase Auth Check Error:", error);
            }
        }

        // ====================================================================
        // --- 3. VOTING FORM LOGIC (Submission) ---
        // ====================================================================

        function createDropdown(options, namePrefix, candidateIndex, initialText) {
            const select = document.createElement('select');
            select.name = `${namePrefix}_${candidateIndex}`;
            select.required = true;
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = `-- ${initialText} --`;
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText.trim();
                option.textContent = optionText.trim();
                select.appendChild(option);
            });
            return select;
        }

        function populateCandidateList() {
            const listEl = document.getElementById('candidate-list');
            listEl.innerHTML = ''; 

            CANDIDATES.sort().forEach((candidate, index) => {
                const li = document.createElement('li');
                
                const nameDiv = document.createElement('div');
                nameDiv.textContent = candidate;
                li.appendChild(nameDiv);

                const committeeDiv = document.createElement('div');
                const committeeSelect = createDropdown(COMMITTEES, 'committee', index, 'Select Committee');
                committeeDiv.appendChild(committeeSelect);
                li.appendChild(committeeDiv);

                const postDiv = document.createElement('div');
                const postSelect = createDropdown(POSTS, 'post', index, 'Select Post');
                postDiv.appendChild(postSelect);
                li.appendChild(postDiv);

                listEl.appendChild(li);
            });
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const statusEl = document.getElementById('status');
            const voterName = sessionStorage.getItem(VOTER_SESSION_KEY);

            if (!voterName) { statusEl.textContent = "‚ùå Error: Voter not identified."; return; }

            const selects = document.querySelectorAll('#voting-form select');
            if (!Array.from(selects).every(select => select.value)) {
                statusEl.textContent = "‚ùå Please make a selection for ALL candidates before submitting.";
                return;
            }

            if (!confirm(`Are you sure you want to submit your vote, ${voterName}? This action is final.`)) {
                return;
            }
            
            statusEl.textContent = "Submitting vote, please wait...";

            const formData = new FormData(event.target);
            const votes = {};
            CANDIDATES.forEach((candidate, index) => {
                votes[candidate] = {
                    committee: formData.get(`committee_${index}`),
                    post: formData.get(`post_${index}`)
                };
            });
            
            const voteData = {
                timestamp: new Date().toISOString(),
                voter: voterName,
                votes: votes
            };

            try {
                const voterRef = ref(database, `${VOTES_NODE}/${voterName}`);
                await set(voterRef, voteData); 

                sessionStorage.removeItem(VOTER_SESSION_KEY);
                
                document.getElementById('voting-form').style.display = 'none';
                statusEl.style.color = '#00897b';
                statusEl.style.fontSize = '1.2em';
                statusEl.innerHTML = `‚úÖ **SUCCESS!** Thank you, ${voterName}, your vote has been recorded.`;

            } catch (error) {
                statusEl.textContent = `‚ùå ERROR: Failed to submit vote. (Check console)`;
                console.error("Firebase Vote Submission Error:", error);
            }
        }

        // ====================================================================
        // --- 4. ADMIN TALLY & CLEAR DATA LOGIC ---
        // ====================================================================

        async function handleClearData() {
            const tallyStatusEl = document.getElementById('tally-status');
            
            const confirmClear = confirm("WARNING: This will permanently delete ALL recorded votes. Proceed?");
            if (!confirmClear) return;
            
            const enteredPassword = prompt("Enter the SUPER ADMIN PASSWORD to confirm data deletion:");
            if (enteredPassword !== SUPER_ADMIN_PASSWORD) {
                tallyStatusEl.textContent = "‚ùå Incorrect password. Data deletion cancelled.";
                return;
            }
            
            tallyStatusEl.textContent = "Deleting all votes, please wait...";

            try {
                const votesRootRef = ref(database, VOTES_NODE);
                await remove(votesRootRef);
                
                tallyStatusEl.innerHTML = "üóëÔ∏è **Success!** All votes have been cleared from the database.";
                document.getElementById('tally-summary').innerHTML = '';
            } catch (error) {
                tallyStatusEl.textContent = "‚ùå Failed to clear votes. Check the Firebase Console for permissions.";
                console.error("Data Deletion Error:", error);
            }
        }

        async function renderTally() {
            const tallyStatusEl = document.getElementById('tally-status');
            const tallySummaryEl = document.getElementById('tally-summary');
            tallySummaryEl.innerHTML = '';
            tallyStatusEl.textContent = "Fetching votes from database...";

            try {
                const votesRef = ref(database, VOTES_NODE);
                const snapshot = await get(votesRef);

                if (!snapshot.exists()) {
                    tallyStatusEl.textContent = "No votes have been recorded yet.";
                    return;
                }

                const allVotes = snapshot.val();
                const totalVoters = Object.keys(allVotes).length;
                
                // Initialize Tally Structure: Committee -> Post -> Candidate -> Count
                const results = {}; 
                const candidateSet = new Set(CANDIDATES); 
                
                // 1. Process all submitted votes
                for (const voterName in allVotes) {
                    const voterVotes = allVotes[voterName].votes;
                    
                    for (const candidateName in voterVotes) {
                        if (!candidateSet.has(candidateName)) continue; 
                        
                        const { committee, post } = voterVotes[candidateName];

                        // Initialize structure if needed
                        if (!results[committee]) results[committee] = {};
                        if (!results[committee][post]) results[committee][post] = {};
                        if (!results[committee][post][candidateName]) results[committee][post][candidateName] = 0;
                        
                        // Increment count
                        results[committee][post][candidateName]++;
                    }
                }
                
                // 2. Generate HTML Output
                let html = '';
                
                const sortedCommittees = Object.keys(results).sort();

                for (const committee of sortedCommittees) {
                    html += `<div class="tally-committee">`;
                    html += `<h3>${committee}</h3>`;
                    
                    const posts = results[committee];
                    
                    for (const post of POSTS) {
                        const postResults = posts[post] || {};
                        
                        // Convert results to an array and sort by count (descending)
                        const sortedCandidates = Object.entries(postResults)
                            .sort(([, countA], [, countB]) => countB - countA);

                        if (sortedCandidates.length > 0) {
                            html += `<h4>${post} (${sortedCandidates.length} Candidates Received Votes)</h4>`;
                            html += `<div class="tally-results">`;
                            
                            sortedCandidates.forEach(([candidate, count]) => {
                                html += `<div class="tally-item">`;
                                html += `<span class="candidate-name">${candidate}</span>`;
                                html += `<span class="vote-count">${count}</span>`;
                                html += `</div>`;
                            });
                            
                            html += `</div>`;
                        } else {
                             html += `<h4>${post} (No votes recorded for this post yet)</h4>`;
                        }
                    }
                    html += `</div>`; // Close tally-committee
                }
                
                tallyStatusEl.innerHTML = `‚úÖ Results loaded successfully! **${totalVoters}** total voters recorded.`;
                tallySummaryEl.innerHTML = html;


            } catch (error) {
                tallyStatusEl.textContent = "‚ùå Failed to load results from Firebase. Check console.";
                console.error("Tally Load Error:", error);
            }
        }
        
        // ====================================================================
        // --- 5. INITIALIZATION ---
        // ====================================================================
        document.addEventListener('DOMContentLoaded', () => {
            populateVoterSelect();
            document.getElementById('enter-btn').addEventListener('click', handleEnter);
            document.getElementById('voting-form').addEventListener('submit', handleSubmit);
            document.getElementById('clear-data-btn').addEventListener('click', handleClearData);
            
            checkInitialView();
        });

    </script>
</body>
</html>
